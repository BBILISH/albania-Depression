<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אלבניה דפרסיה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- PWA related meta tags and links -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3CB371">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0ffe0, #a0d0a0); /* Light to dark green gradient */
            color: #333;
            line-height: 1.6;
            scroll-behavior: smooth;
        }
        .navbar {
            background: linear-gradient(to right, #228B22, #3CB371); /* Darker green gradient */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 1.5rem; /* Rounded bottom corners */
            border-bottom-right-radius: 1.5rem;
            z-index: 1000;
        }
        .hero-section {
            background: linear-gradient(to bottom right, #90EE90, #3CB371); /* Light to dark green gradient */
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .section-title {
            color: #228B22; /* Dark green */
            border-bottom: 2px solid #3CB371;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .collapsible-header {
            /* Default styles, cursor will be set dynamically */
            transition: background-color 0.2s ease-in-out;
        }
        .collapsible-header.cursor-pointer:hover {
            background-color: #f0f0f0;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.open {
            max-height: 1000px; /* Adjust as needed for content */
            transition: max-height 0.5s ease-in;
        }
        .btn-primary {
            background-color: #3CB371; /* Medium green */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #2E8B57; /* Darker green on hover */
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            margin-inline-end: 0.25em;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: left; /* Changed from right to left for RTL */
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Mobile menu specific styles */
        @media (max-width: 768px) {
            .navbar-menu {
                display: none;
                flex-direction: column;
                width: 100%;
                background: linear-gradient(to right, #228B22, #3CB371);
                border-bottom-left-radius: 1.5rem;
                border-bottom-right-radius: 1.5rem;
                padding-bottom: 1rem;
            }
            .navbar-menu.open {
                display: flex;
            }
            .navbar-menu a {
                padding: 0.75rem 1rem;
                text-align: center;
            }
        }

        /* Edit mode specific styles */
        body:not(.edit-mode) .edit-controls {
            display: none !important;
        }
        body.edit-mode .read-controls {
            display: none !important;
        }
        body.edit-mode .edit-controls {
            display: block; /* Or flex, inline-block depending on element */
        }
        body.edit-mode .activity-time-display {
            display: none !important;
        }
        body:not(.edit-mode) .activity-time-input {
            display: none !important;
        }
        body:not(.edit-mode) .activity-time-display {
            display: inline !important;
        }

        /* Notes and images visibility */
        body:not(.edit-mode) textarea.edit-controls,
        body:not(.edit-mode) input[type="file"].edit-controls {
            display: none !important;
        }
        body.edit-mode textarea.edit-controls,
        body.edit-mode input[type="file"].edit-controls {
            display: block !important;
        }
        /* Ensure notes and image previews are always visible in read mode */
        body:not(.edit-mode) .collapsible-content-notes p.read-mode-note,
        body:not(.edit-mode) .collapsible-content-notes .image-preview img {
            display: block !important;
        }
        body.edit-mode .collapsible-content-notes p.read-mode-note {
            display: none !important;
        }

        /* Styles to make collapsible content always open in read mode */
        body:not(.edit-mode) .collapsible-content {
            max-height: 2000px !important; /* Sufficiently large to show all content */
            overflow: visible !important;
        }
        body:not(.edit-mode) .collapsible-header span {
            display: none !important; /* Hide the arrow in read mode */
        }
        body:not(.edit-mode) .collapsible-header {
            cursor: default !important; /* No pointer cursor in read mode */
        }
    </style>
</head>
<body class="text-right">

    <!-- Navbar -->
    <nav class="navbar p-4 sticky top-0 w-full flex flex-wrap justify-center items-center">
        <div class="container mx-auto flex justify-between items-center px-4">
            <div class="text-white text-2xl font-bold">אלבניה דפרסיה</div>
            <div class="flex items-center space-x-4 space-x-reverse">
                <button id="edit-mode-toggle" class="btn-primary text-sm px-3 py-1">מצב עריכה</button>
                <div class="md:hidden">
                    <button id="hamburger" class="text-white focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
                <div class="navbar-menu hidden md:flex space-x-4 space-x-reverse">
                    <a href="#itinerary" class="text-white hover:text-gray-200 transition duration-200 read-controls">מסלול הטיול</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-center py-20 rounded-b-3xl mb-8">
        <h1 class="text-5xl font-extrabold mb-4">אלבניה דפרסיה</h1>
        <p class="text-2xl font-medium">28 באוגוסט - 7 בספטמבר</p>
    </section>

    <main class="container mx-auto p-4">

        <!-- Itinerary Section -->
        <section id="itinerary" class="mb-12">
            <h2 class="section-title text-4xl font-bold mb-8 pb-2 text-center">🗺️ מסלול הטיול</h2>

            <div id="itinerary-days" class="space-y-8">
                <!-- Itinerary days will be dynamically loaded here by JavaScript -->
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-12 rounded-t-3xl">
        <p>&copy; 2024 אלבניה דפרסיה. כל הזכויות שמורות.</p>
    </footer>

    <!-- Modal for editing links -->
    <div id="editLinkModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ערוך קישור</h2>
            <input type="text" id="linkInput" class="w-full p-2 border rounded-md mb-4" placeholder="הכנס URL חדש">
            <button id="saveLinkBtn" class="btn-primary">שמור</button>
        </div>
    </div>

    <!-- Modal for editing travel times -->
    <div id="editTravelTimeModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ערוך זמן נסיעה</h2>
            <label for="distanceInput" class="block text-lg font-medium mb-2">מרחק (ק"מ):</label>
            <input type="number" id="distanceInput" class="w-full p-2 border rounded-md mb-4" placeholder="מרחק בקילומטרים">
            <label for="hoursInput" class="block text-lg font-medium mb-2">שעות:</label>
            <input type="number" id="hoursInput" class="w-full p-2 border rounded-md mb-4" placeholder="שעות">
            <label for="minutesInput" class="block text-lg font-medium mb-2">דקות:</label>
            <input type="number" id="minutesInput" class="w-full p-2 border rounded-md mb-4" placeholder="דקות">
            <button id="saveTravelTimeBtn" class="btn-primary">שמור</button>
        </div>
    </div>

    <script>
        // Helper function to format time (HH:MM)
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Helper function to parse time (HH:MM) into minutes from midnight
        function parseTime(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Helper function to convert minutes from midnight to HH:MM string
        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // Main data structure for itinerary
        const appData = {
            itinerary: [
                {
                    id: 'day1',
                    hebrewDate: 'יום חמישי, 28 באוגוסט',
                    description: 'שקודר', /* Updated description */
                    activities: [
                        // Changed duration to 0, assuming startTime is arrival time
                        { name: 'תל אביב-יפו - טירנה', type: 'required', url: 'https://maps.google.com/?q=Tirana+International+Airport', duration: 0, notes: '', image: '' },
                        { name: 'השכרת רכב בטירנה - VT Rentals', type: 'required', url: 'https://wa.me/355694000031', duration: 0, notes: '', image: '' },
                        { name: 'אחלה דירה בשקודר', type: 'required', url: 'https://maps.google.com/?q=Rruga+Edith+Durham+25,+Shkod%C3%ABr+4001,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 61.3, hours: 0, minutes: 40 }, // Changed travel time to 40 minutes
                        { distance: 0, hours: 0, minutes: 1 }
                    ],
                    lodging: {
                        name: 'אחלה דירה בשקודר',
                        address: 'Rruga Edith Durham 25, Shkodër 4001, Albania',
                        dates: 'חמישי, 28 באוגוסט - שישי, 29 באוגוסט',
                        confirmation: 'HM8TMAKB43',
                        whatsapp: '355694552255'
                    }
                },
                {
                    id: 'day2',
                    hebrewDate: 'יום שישי, 29 באוגוסט',
                    description: 'לשים אוכל במקרר אומגה ומסלול טיול בצפון', /* Updated description */
                    activities: [
                        { name: 'אחלה דירה בשקודר', type: 'required', url: 'https://maps.google.com/?q=Rruga+Edith+Durham+25,+Shkod%C3%ABr+4001,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'לשים אוכל במקרר', type: 'required', url: '', duration: 0, notes: '', image: '' }, // Renamed from Camping_Private Kabine
                        { name: 'Thethi Zipline', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'Thet Thet Khaing', type: 'required', url: 'https://www.wikiloc.com/hiking-trails/valle-de-theth-okol-y-ki-shtrazes-desde-theth-78816286/photo-51245713', duration: 0, notes: '', image: '' },
                        { name: 'מקום עם נוף יפה בדרך', type: 'required', url: '', duration: 0, notes: '', image: '' }, // Renamed from Buni i Bajraktarit
                        { name: 'North Alpine Villas', type: 'required', url: 'https://maps.google.com/?q=9MXH%2B63,+Bog%C3%AB,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 15.7, hours: 0, minutes: 48 }, // Travel from אחלה דירה בשקודר to לשים אוכל במקרר (original was from North Alpine Villas to Camping_Private Kabine)
                        { distance: 1.8, hours: 0, minutes: 12 },
                        { distance: 10.7, hours: 0, minutes: 39 },
                        { distance: 5.4, hours: 0, minutes: 17 },
                        { distance: 0, hours: 0, minutes: 1 }
                    ],
                    lodging: {
                        name: 'North Alpine Villas',
                        address: '9MXH+63, Bogë, Albania',
                        dates: 'שישי, 29 באוגוסט - ראשון, 31 באוגוסט',
                        confirmation: 'HMR3XMBREA',
                        whatsapp: '355699955869'
                    }
                },
                {
                    id: 'day3',
                    hebrewDate: 'יום שבת, 30 באוגוסט',
                    description: 'שבת בboge', /* Updated description */
                    activities: [
                        { name: 'North Alpine Villas', type: 'required', url: 'https://maps.google.com/?q=9MXH%2B63,+Bog%C3%AB,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [],
                    lodging: {
                        name: 'North Alpine Villas',
                        address: '9MXH+63, Bogë, Albania',
                        dates: 'שישי, 29 באוגוסט - ראשון, 31 באוגוסט',
                        confirmation: 'HMR3XMBREA',
                        whatsapp: '355699955869'
                    }
                },
                {
                    id: 'day4',
                    hebrewDate: 'יום ראשון, 31 באוגוסט',
                    description: 'טיול באגם רכבל ליד וזיפליין שינה בדורס', /* Updated description */
                    activities: [
                        { name: 'North Alpine Villas', type: 'required', url: 'https://maps.google.com/?q=9MXH%2B63,+Bog%C3%AB,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'Lake Bovilla', type: 'required', url: 'https://www.wikiloc.com/hiking-trails/lake-bovilla-gamti-mountain-lake-bovilla-34432538', duration: 0, notes: '', image: '' },
                        { name: 'Dajti Ekspres', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'Zipline Albania', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'אחלה דירה בדורוס', type: 'required', url: 'https://maps.google.com/?q=8F6M%2B3CC,+Rruga+Pavaresia+2002,+Durr%C3%ABs+2002,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 99.7, hours: 3, minutes: 43 },
                        { distance: 11, hours: 0, minutes: 39 },
                        { distance: 11.6, hours: 0, minutes: 23 },
                        { distance: 32.6, hours: 0, minutes: 50 }
                    ],
                    lodging: {
                        name: 'אחלה דירה בדורוס',
                        address: '8F6M+3CC, Rruga Pavaresia 2002, Durrës 2002, Albania',
                        dates: 'ראשון, 31 באוגוסט - שני, 1 בספטמבר',
                        confirmation: 'HMMFKKD2ZH',
                        whatsapp: '355696865066'
                    }
                },
                {
                    id: 'day5',
                    hebrewDate: 'יום שני, 1 בספטמבר',
                    description: 'גשרים והגעה לדירה בולורה', /* Updated description */
                    activities: [
                        { name: 'אחלה דירה בדורוס', type: 'required', url: 'https://maps.google.com/?q=8F6M%2B3CC,+Rruga+Pavaresia+2002,+Durr%C3%ABs+2002,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'Bridge of Brataj', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'Zvernec bridge', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 93.9, hours: 2, minutes: 21 },
                        { distance: 25.3, hours: 1, minutes: 1 },
                        { distance: 10.6, hours: 0, minutes: 24 },
                        { distance: 10.2, hours: 0, minutes: 24 }
                    ],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                },
                {
                    id: 'day6',
                    hebrewDate: 'יום שלישי, 2 בספטמבר',
                    description: 'טיול speedboat בולורה', /* Updated description */
                    activities: [
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'TripMe.Today Boat Tour & Boat Trips Vlore', type: 'required', url: 'https://www.tripme.today/en_GB/activity/298525/speedboat-ticket-for-grand-tour-national-park-grama-bay.', duration: 0, notes: '', image: '' },
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 32, hours: 0, minutes: 7 },
                        { distance: 3.1, hours: 0, minutes: 6 }
                    ],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                },
                {
                    id: 'day7',
                    hebrewDate: 'יום רביעי, 3 בספטמבר',
                    description: 'עין כחולה עיר נחמדה',
                    activities: [
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'Gjirokastër', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'The Blue Eye', type: 'required', url: '', duration: 0, notes: '', image: '' },
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 83.9, hours: 2, minutes: 3 },
                        { distance: 22.6, hours: 1, minutes: 12 },
                        { distance: 110, hours: 3, minutes: 11 }
                    ],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                },
                {
                    id: 'day8',
                    hebrewDate: 'יום חמישי, 4 בספטמבר',
                    description: 'טיול בקניון אוסומי', /* Updated description */
                    activities: [
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'Osumi Canyon viewing point', type: 'required', url: 'https://www.getyourguide.com/corovoda-1185185/corovoda-osumi-canyon-raftingriver-tubing-tour-1681710/', duration: 0, notes: '', image: '' },
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 101, hours: 2, minutes: 39 },
                        { distance: 101, hours: 2, minutes: 41 }
                    ],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                },
                {
                    id: 'day9',
                    hebrewDate: 'יום שישי, 5 בספטמבר',
                    description: 'מתארגנים לשבת ועושים מה שבא', /* Updated description */
                    activities: [
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                },
                {
                    id: 'day10',
                    hebrewDate: 'יום שבת, 6 בספטמבר',
                    description: 'נרגעים בשבת', /* Updated description */
                    activities: [
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                },
                {
                    id: 'day11',
                    hebrewDate: 'יום ראשון, 7 בספטמבר',
                    description: 'היום שחוזרים בו', /* Updated description */
                    activities: [
                        { name: 'דירה יפה מול הים', type: 'required', url: 'https://maps.google.com/?q=KALAJA,+Rr.+Aleksander+Moisiu,+vis-a-vis+plazhit,+Vlor%C3%AB+9405,+Albania', duration: 0, notes: '', image: '' },
                        { name: 'השכרת רכב בטירנה - VT Rentals', type: 'required', url: 'https://wa.me/355694000031', duration: 0, notes: '', image: '' },
                        { name: 'טירנה - תל אביב-יפו', type: 'required', url: 'https://maps.google.com/?q=Tirana+International+Airport', duration: 0, notes: '', image: '' }
                    ],
                    travelTimes: [
                        { distance: 102, hours: 2, minutes: 12 },
                        { distance: 0, hours: 0, minutes: 0 }
                    ],
                    lodging: {
                        name: 'דירה יפה מול הים',
                        address: 'KALAJA, Rr. Aleksander Moisiu, vis-a-vis plazhit, Vlorë 9405, Albania',
                        dates: 'שני, 1 בספטמבר - ראשון, 7 בספטמבר',
                        confirmation: 'HM48PSE5EQ',
                        whatsapp: '355694884466'
                    }
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const itineraryDaysContainer = document.getElementById('itinerary-days');
            const editModeToggle = document.getElementById('edit-mode-toggle');
            const body = document.body;

            // Load edit mode state from localStorage
            let isEditMode = localStorage.getItem('editMode') === 'true';
            if (isEditMode) {
                body.classList.add('edit-mode');
                editModeToggle.textContent = 'מצב קריאה';
            } else {
                body.classList.remove('edit-mode');
                editModeToggle.textContent = 'מצב עריכה';
            }

            // Toggle edit mode
            editModeToggle.addEventListener('click', () => {
                isEditMode = !isEditMode;
                if (isEditMode) {
                    body.classList.add('edit-mode');
                    editModeToggle.textContent = 'מצב קריאה';
                } else {
                    body.classList.remove('edit-mode');
                    editModeToggle.textContent = 'מצב עריכה';
                }
                localStorage.setItem('editMode', isEditMode);
                renderItinerary(); // Re-render to apply new mode styles
            });

            // Function to handle collapsible sections
            const setupCollapsibles = (selector, storageKeyPrefix, containerId) => {
                // Only attach listeners in edit mode
                if (!isEditMode) {
                    // Remove existing listeners if any were attached in previous edit mode
                    document.querySelectorAll(selector).forEach(header => {
                        const oldHeader = header.cloneNode(true);
                        header.parentNode.replaceChild(oldHeader, header);
                    });
                    return;
                }

                // Remove existing listeners to prevent duplicates on re-render
                document.querySelectorAll(selector).forEach(header => {
                    const oldHeader = header.cloneNode(true);
                    header.parentNode.replaceChild(oldHeader, header);
                });

                document.querySelectorAll(selector).forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const id = header.dataset[storageKeyPrefix + 'Id'];
                        let openItems = JSON.parse(localStorage.getItem(storageKeyPrefix + 's_' + containerId)) || [];

                        if (content.classList.contains('open')) {
                            content.classList.remove('open');
                            header.querySelector('span').textContent = '▼';
                            openItems = openItems.filter(item => item !== id);
                        } else {
                            content.classList.add('open');
                            header.querySelector('span').textContent = '▲';
                            if (!openItems.includes(id)) {
                                openItems.push(id);
                            }
                        }
                        localStorage.setItem(storageKeyPrefix + 's_' + containerId, JSON.stringify(openItems));
                    });
                });
            };

            // Initialize collapsible sections based on Local Storage
            const initializeCollapsibles = (selector, storageKeyPrefix, containerId) => {
                // Only initialize based on storage in edit mode
                if (!isEditMode) return;

                const openItems = JSON.parse(localStorage.getItem(storageKeyPrefix + 's_' + containerId)) || [];
                document.querySelectorAll(selector).forEach(header => {
                    const content = header.nextElementSibling;
                    const id = header.dataset[storageKeyPrefix + 'Id'];
                    if (openItems.includes(id)) {
                        content.classList.add('open');
                        header.querySelector('span').textContent = '▲';
                    }
                });
            };

            // Save/Load data from Local Storage
            const saveAppData = () => {
                localStorage.setItem('appData', JSON.stringify(appData));
            };

            const loadAppData = () => {
                const savedData = localStorage.getItem('appData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Merge saved data with default structure to handle new fields/activities
                    appData.itinerary = appData.itinerary.map(day => {
                        const savedDay = parsedData.itinerary.find(d => d.id === day.id);
                        if (savedDay) {
                            return {
                                ...day,
                                description: savedDay.description !== undefined ? savedDay.description : day.description, /* Ensure description is loaded */
                                activities: day.activities.map((activity, idx) => {
                                    const savedActivity = savedDay.activities[idx];
                                    // Ensure notes and image are loaded from saved data if available
                                    return savedActivity ? {
                                        ...activity,
                                        ...savedActivity,
                                        notes: savedActivity.notes !== undefined ? savedActivity.notes : activity.notes,
                                        image: savedActivity.image !== undefined ? savedActivity.image : activity.image
                                    } : activity;
                                }),
                                travelTimes: day.travelTimes.map((travel, idx) => {
                                    const savedTravel = savedDay.travelTimes[idx];
                                    return savedTravel ? { ...travel, ...savedTravel } : travel;
                                }),
                                lodging: savedDay.lodging ? { ...day.lodging, ...savedDay.lodging } : day.lodging
                            };
                        }
                        return day;
                    });
                }
            };

            // Recalculate activity times for a specific day
            const recalculateTimesForDay = (dayIndex) => {
                const day = appData.itinerary[dayIndex];
                if (!day || day.activities.length === 0) return;

                let currentTimeInMinutes = parseTime(day.activities[0].startTime || "00:00"); // Start from first activity's time or 00:00

                day.activities.forEach((activity, activityIndex) => {
                    // For activities after the first one, add the duration of the previous activity
                    // and the travel time to the current activity.
                    if (activityIndex > 0) {
                        currentTimeInMinutes += day.activities[activityIndex - 1].duration; // Add duration of previous activity
                        const travel = day.travelTimes[activityIndex - 1];
                        if (travel) {
                            currentTimeInMinutes += (travel.hours * 60) + travel.minutes;
                        }
                    }
                    activity.startTime = minutesToTime(currentTimeInMinutes);
                });
                saveAppData();
                renderItinerary(); // Re-render the specific day or entire itinerary
            };

            // Render Itinerary
            const renderItinerary = () => {
                itineraryDaysContainer.innerHTML = ''; // Clear existing content
                appData.itinerary.forEach((day, dayIndex) => {
                    let activitiesHtml = '';
                    day.activities.forEach((activity, activityIndex) => {
                        const activityId = `${day.id}-activity${activityIndex + 1}`;
                        const currentNotes = activity.notes;
                        const currentImage = activity.image;
                        const currentLink = activity.url;

                        // Add travel time before each activity except the first one
                        if (activityIndex > 0) {
                            const travel = day.travelTimes[activityIndex - 1];
                            const travelId = `${day.id}-travel${activityIndex}`;
                            activitiesHtml += `
                                <div class="travel-time flex items-center justify-end my-4 edit-controls">
                                    <span class="text-gray-600 ml-2">↓ (כ-${travel.distance} ק"מ, ${travel.hours} ש' ${travel.minutes} דק')</span>
                                    <button class="btn-secondary edit-travel-time-btn" data-travel-id="${travelId}" data-day-index="${dayIndex}" data-travel-index="${activityIndex - 1}">✏️ ערוך</button>
                                </div>
                            `;
                        }

                        activitiesHtml += `
                            <div class="activity-item mb-4">
                                <p class="text-lg font-medium">
                                    <span class="activity-time-display">${activity.startTime || '00:00'}</span>
                                    <input type="time" class="activity-time-input p-1 border rounded-md edit-controls" value="${activity.startTime || '00:00'}" data-day-index="${dayIndex}" data-activity-index="${activityIndex}">
                                    <span class="font-bold">${activity.type === 'required' ? '✅' : '💡'} ${activity.name}</span>
                                </p>
                                <div class="flex items-center space-x-2 space-x-reverse mt-2">
                                    <a href="${currentLink}" class="btn-primary flex items-center nav-link read-controls" data-url="${currentLink}" target="_blank">
                                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
                                        נווט
                                    </a>
                                    <button class="btn-secondary edit-link-btn flex items-center edit-controls" data-day-index="${dayIndex}" data-activity-index="${activityIndex}">
                                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293A1 1 0 018.707 14H5a1 1 0 01-1-1v-3.707a1 1 0 01.293-.707l7.293-7.293zM10 2a8 8 0 100 16 8 8 0 000-16z"></path></svg>
                                        ערוך קישור ניווט
                                    </button>
                                </div>
                                <div class="collapsible-content-notes mt-2">
                                    <textarea class="w-full p-2 border rounded-md edit-controls" placeholder="הערות אישיות..." data-day-index="${dayIndex}" data-activity-index="${activityIndex}">${currentNotes}</textarea>
                                    <input type="file" accept="image/*" class="w-full mt-2 edit-controls" data-day-index="${dayIndex}" data-activity-index="${activityIndex}">
                                    <div class="image-preview mt-2" data-day-index="${dayIndex}" data-activity-index="${activityIndex}">
                                        ${currentImage ? `<img src="${currentImage}" class="w-32 h-32 object-cover rounded-md mt-2">` : ''}
                                    </div>
                                    ${currentNotes ? `<p class="text-gray-700 mt-2 read-mode-note">${currentNotes}</p>` : ''}
                                </div>
                            </div>
                        `;
                    });

                    // Determine if the day content should be open (always in read mode, based on storage in edit mode)
                    const isDayOpen = isEditMode ? (JSON.parse(localStorage.getItem('day_s_itinerary-days')) || []).includes(day.id) : true;
                    // Determine if the lodging content should be open
                    const isLodgingOpen = isEditMode ? (JSON.parse(localStorage.getItem('lodging_s_itinerary-days')) || []).includes(`${day.id}-lodging`) : true;

                    // Determine header classes based on edit mode
                    const headerCursorClass = isEditMode ? 'cursor-pointer' : 'cursor-default';
                    const arrowDisplayClass = isEditMode ? '' : 'hidden'; // Tailwind's hidden class

                    itineraryDaysContainer.innerHTML += `
                        <div class="card p-6" id="${day.id}">
                            <div class="collapsible-header flex justify-between items-center mb-4 ${headerCursorClass}" data-day-id="${day.id}">
                                <h3 class="text-2xl font-semibold">${day.hebrewDate} - ${day.description}</h3>
                                <span class="text-xl ${arrowDisplayClass}">${isDayOpen ? '▲' : '▼'}</span>
                            </div>
                            <div class="collapsible-content ${isDayOpen ? 'open' : ''}">
                                ${activitiesHtml}
                                <div class="lodging mt-6 p-4 bg-gray-50 rounded-lg">
                                    <div class="collapsible-header flex justify-between items-center ${headerCursorClass}" data-lodging-id="${day.id}-lodging">
                                        <h4 class="text-xl font-semibold">🏠 לינה: ${day.lodging.name}</h4>
                                        <span class="text-xl ${arrowDisplayClass}">${isLodgingOpen ? '▲' : '▼'}</span>
                                    </div>
                                    <div class="collapsible-content ${isLodgingOpen ? 'open' : ''}">
                                        <p><strong>כתובת:</strong> ${day.lodging.address}</p>
                                        <p><strong>תאריכים:</strong> ${day.lodging.dates}</p>
                                        <p><strong>אישור הזמנה:</strong> ${day.lodging.confirmation}</p>
                                        <p><strong>וואטסאפ:</strong> <a href="https://wa.me/${day.lodging.whatsapp}" target="_blank" class="text-blue-500 hover:underline">${day.lodging.whatsapp}</a></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Re-attach event listeners after rendering
                attachItineraryEventListeners();
                // Only initialize collapsibles if in edit mode
                if (isEditMode) {
                    initializeCollapsibles('.collapsible-header[data-day-id]', 'day', 'itinerary-days');
                    initializeCollapsibles('.collapsible-header[data-lodging-id]', 'lodging', 'itinerary-days');
                }
            };

            // Attach event listeners for itinerary section
            const attachItineraryEventListeners = () => {
                // Only setup collapsibles if in edit mode
                setupCollapsibles('.collapsible-header[data-day-id]', 'day', 'itinerary-days');
                setupCollapsibles('.collapsible-header[data-lodging-id]', 'lodging', 'itinerary-days');

                document.querySelectorAll('.activity-time-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const dayIndex = parseInt(e.target.dataset.dayIndex);
                        const activityIndex = parseInt(e.target.dataset.activityIndex);
                        appData.itinerary[dayIndex].activities[activityIndex].startTime = e.target.value;
                        recalculateTimesForDay(dayIndex);
                    });
                });

                document.querySelectorAll('.edit-travel-time-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const dayIndex = parseInt(e.target.dataset.dayIndex);
                        const travelIndex = parseInt(e.target.dataset.travelIndex);
                        const travel = appData.itinerary[dayIndex].travelTimes[travelIndex];

                        distanceInput.value = travel.distance;
                        hoursInput.value = travel.hours;
                        minutesInput.value = travel.minutes;

                        saveTravelTimeBtn.onclick = () => {
                            const newDistance = parseFloat(distanceInput.value);
                            const newHours = parseInt(hoursInput.value);
                            const newMinutes = parseInt(minutesInput.value);

                            if (isNaN(newDistance) || isNaN(newHours) || isNaN(newMinutes)) {
                                alert('אנא הזן ערכים מספריים תקינים.');
                                return;
                            }

                            appData.itinerary[dayIndex].travelTimes[travelIndex] = {
                                distance: newDistance,
                                hours: newHours,
                                minutes: newMinutes
                            };
                            recalculateTimesForDay(dayIndex); // Recalculate times for the day
                            editTravelTimeModal.style.display = 'none';
                        };
                        editTravelTimeModal.style.display = 'flex';
                    });
                });

                // Notes for itinerary activities - save directly to appData and update display
                document.querySelectorAll('textarea[data-day-index][data-activity-index]').forEach(textarea => {
                    const dayIndex = parseInt(textarea.dataset.dayIndex);
                    const activityIndex = parseInt(textarea.dataset.activityIndex);
                    // Set initial value from appData
                    textarea.value = appData.itinerary[dayIndex].activities[activityIndex].notes;

                    textarea.addEventListener('input', (e) => {
                        appData.itinerary[dayIndex].activities[activityIndex].notes = e.target.value;
                        saveAppData();
                        // Update the read-mode note display directly
                        const readModeNote = textarea.closest('.collapsible-content-notes').querySelector('.read-mode-note');
                        if (readModeNote) {
                            readModeNote.textContent = e.target.value;
                            readModeNote.style.display = e.target.value ? 'block' : 'none';
                        }
                    });
                });

                // Images for itinerary activities - save directly to appData and update display
                document.querySelectorAll('input[type="file"][data-day-index][data-activity-index]').forEach(input => {
                    const dayIndex = parseInt(input.dataset.dayIndex);
                    const activityIndex = parseInt(input.dataset.activityIndex);
                    const previewContainer = input.nextElementSibling; // Get the image-preview div

                    // Set initial image from appData
                    if (appData.itinerary[dayIndex].activities[activityIndex].image) {
                        previewContainer.innerHTML = `<img src="${appData.itinerary[dayIndex].activities[activityIndex].image}" class="w-32 h-32 object-cover rounded-md mt-2">`;
                    } else {
                        previewContainer.innerHTML = '';
                    }

                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];

                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (readerEvent) => {
                                const base64 = readerEvent.target.result;
                                appData.itinerary[dayIndex].activities[activityIndex].image = base64;
                                saveAppData();
                                previewContainer.innerHTML = `<img src="${base64}" class="w-32 h-32 object-cover rounded-md mt-2">`;
                            };
                            reader.readAsDataURL(file);
                        } else {
                            appData.itinerary[dayIndex].activities[activityIndex].image = '';
                            saveAppData();
                            previewContainer.innerHTML = '';
                        }
                    });
                });

                // Link editing for itinerary activities - save directly to appData
                document.querySelectorAll('.activity-item .edit-link-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const dayIndex = parseInt(e.target.dataset.dayIndex);
                        const activityIndex = parseInt(e.target.dataset.activityIndex);
                        const activity = appData.itinerary[dayIndex].activities[activityIndex];

                        linkInput.value = activity.url;
                        saveLinkBtn.onclick = () => {
                            const newUrl = linkInput.value;
                            activity.url = newUrl; // Update appData directly
                            saveAppData();
                            editLinkModal.style.display = 'none';
                            // Update the nav-link href directly without full re-render
                            const navLink = button.closest('.activity-item').querySelector('.nav-link');
                            if (navLink) {
                                navLink.href = newUrl;
                                navLink.dataset.url = newUrl;
                            }
                        };
                        editLinkModal.style.display = 'flex';
                    });
                });
            };

            // Common modal close button logic
            document.querySelectorAll('.modal .close-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.modal').style.display = 'none';
                });
            });

            // Navigation links for smooth scrolling
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth'
                        });
                    } else {
                        console.error(`Element with ID ${targetId} not found.`);
                    }
                });
            });

            // Hamburger menu functionality
            const hamburger = document.getElementById('hamburger');
            const navbarMenu = document.querySelector('.navbar-menu');

            hamburger.addEventListener('click', () => {
                navbarMenu.classList.toggle('hidden');
                navbarMenu.classList.toggle('open');
            });

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

            // Initial load and render
            loadAppData();

            // Set initial start times for all activities based on hardcoded first activity time
            // For simplicity, we'll assume the first activity of Day 1 starts at 13:00
            // and subsequent days start at 00:00 unless specified otherwise.
            // In a real app, you might want to allow setting start time for each day.
            if (appData.itinerary[0].activities[0].startTime === undefined) {
                appData.itinerary[0].activities[0].startTime = "13:00";
            }
            appData.itinerary.forEach((day, index) => {
                if (index > 0 && day.activities[0].startTime === undefined) {
                    day.activities[0].startTime = "00:00";
                }
                recalculateTimesForDay(index);
            });

            renderItinerary();
        });
    </script>
</body>
</html>
